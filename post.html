<!doctype html>
<html lang="en" data-theme="">
  <head>
    <meta charset="utf-8">
    <title>post</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark">

    <style>
      :root {
        --bg: #ffffff;
        --fg: #111111;
        --link: #005bff;
        --mark-light: rgba(255, 241, 118, 0.9);
        --mark-dark: rgba(255, 235, 59, 0.55);
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #000000;
          --fg: #ffffff;
          --link: #8fc9ed;
        }
      }

      [data-theme="dark"] {
        --bg: #000000;
        --fg: #ffffff;
        --link: #8fc9ed;
      }

      html, body {
        height: 100%;
      }

      body {
        margin: 0;
        background: var(--bg);
        color: var(--fg);
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
        line-height: 1.4;
        -webkit-font-smoothing: antialiased;
        padding: 16px;
      }

      a, a:visited {
        color: var(--link);
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }

      pre {
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .err {
        color: #d33;
        white-space: pre-wrap;
      }

      /* Marker-style highlight */
      mark {
        background: none;
        color: inherit;
        padding: 0 2px;
        background-image: linear-gradient(
          transparent 62%,
          var(--mark-light) 62%
        );
      }

      @media (prefers-color-scheme: dark) {
        mark {
          background-image: linear-gradient(
            transparent 55%,
            var(--mark-dark) 55%
          );
        }
      }
    </style>
  </head>

  <body>
    <pre id="content">Loadingâ€¦</pre>

    <script>
      (function () {
        const KEY = "tc-theme";
        const root = document.documentElement;
        let theme = null;
        try {
          const saved = localStorage.getItem(KEY);
          if (saved === "dark" || saved === "light") theme = saved;
        } catch (_) {}
        if (!theme) {
          theme = matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
        }
        root.setAttribute("data-theme", theme);
      }());

      function getPath() {
        if (location.hash && location.hash.length > 1) {
          return location.hash.slice(1);
        }
        const params = new URLSearchParams(location.search);
        return params.get("p");
      }

      function load() {
        const out = document.getElementById("content");
        const path = getPath();

        if (!path) {
          out.textContent = "Missing ?p=path/to/file.txt or #path/to/file.txt";
          out.className = "err";
          return;
        }

        document.title = path.split("/").pop() || "post";

        fetch(path, { cache: "no-store" })
          .then(r => {
            if (!r.ok) throw new Error("HTTP " + r.status);
            return r.text();
          })
          .then(text => {
            const firstLine = (text.split("\n")[0] || "").trim();
            if (firstLine && firstLine.length <= 120) {
              document.title = firstLine.replace(/^#\s*/, "");
            }

            let html = text
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;");

            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (_, label, url) =>
              `<a href="${url}">${label}</a>`
            );

            html = html.replace(/!!([^!]+)!!/g, "<mark>$1</mark>");

            out.innerHTML = html;
            out.className = "";
          })
          .catch(err => {
            out.textContent = "Failed to load " + path + "\n" + err;
            out.className = "err";
          });
      }

      window.addEventListener("hashchange", load);
      window.addEventListener("popstate", load);
      load();
    </script>
  </body>
</html>